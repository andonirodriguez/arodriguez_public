<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Andoni Rodriguez Personal Site</title>
    <meta charset="utf-8">
    <meta name="description" content="Andoni Rodriguez Personal Site" />
    <meta name="robots" content="index,follow">
    <!-- Open Graph Protocol Meta -->
    <meta property='og:title' content='Andoni Rodriguez - Personal Site' />
    <meta property='og:url' content='http://www.andonirodriguez.com' />
    <meta property='og:image' content='http://www.andonirodriguez.com/static/img/home-bg.jpg' />
    <meta property='og:type' content='website' />
    <meta property='og:description' content='Andoni Rodriguez - Personal Site' />
    <!-- END Open Graph Protocol Meta -->
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Andoni Rodriguez - Personal Site" />
    <meta name="twitter:description" content="Andoni Rodriguez - Personal Site" />
    <meta name="twitter:url" content="http://www.andonirodriguez.com" />
    <meta name="twitter:image" content="http://www.andonirodriguez.com/static/img/home-bg.jpg" />
    <!-- END Twitter Cards -->


    <!-- Bootstrap Core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/static/css/clean-blog.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Google Analytics -->
    <script src="/static/js/analyticstracking.js"></script>


</head>

<script id="mcjs">!function(c,h,i,m,p){m=c.createElement(h),p=c.getElementsByTagName(h)[0],m.async=1,m.src=i,p.parentNode.insertBefore(m,p)}(document,"script","https://chimpstatic.com/mcjs-connected/js/users/c797fd4414a2173ba89d1552d/dde80ea88a3aa58c45922e85d.js");</script>


    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('/static/img/home-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="site-heading">
                        <h2>Andoni Rodríguez</h2>
                        <hr class="small">
                        <span class="subheading">Articulos</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Andoni Rodríguez</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    <li>
                        <a href="/posts/">Articulos</a>
                    </li>
                    <li>
                        <a href="/projects/">Proyectos</a>
                    </li>
                    <li>
                        <a href="/contact/">Contacto</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>



    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <h1>Docker &amp; Docker Compose</h1>
                    <hr>
                    <h2 class="subheading">Comprehensive introduction to development with Docker and Docker Compose</h2>
                    <p>Every day it is more common to find applications inside containers. Docker is becoming the standard to develop, build 
and share containers.</p>
<p>According to their website</p>
<blockquote>
<p>Docker is an open platform for developing, shipping, and running applications. Docker enables you to separate your 
applications from your infrastructure so you can deliver software quickly. With Docker, you can manage your 
infrastructure in the same ways you manage your applications. By taking advantage of Docker’s methodologies for 
shipping, testing, and deploying code quickly, you can significantly reduce the delay between writing code and running 
it in production.</p>
</blockquote>
<p><strong>Docker</strong> is a great tool in multiple cases, like when you want to package an application and show it to someone, or you 
want to do software installation tests without having to install software on your own operating system.</p>
<p>With <strong>Docker Compose</strong> we can go a step further, it gives us a lot of options to develop on containers, as well as a 
minimum of orchestration between them.</p>
<blockquote>
<p>If you've never worked with Docker, I recommend that you take a look at their website. They have very good and complete 
tutorials for all levels. Specifically, <a href="https://docs.docker.com/engine/getstarted/">this</a> may seem simple but it 
helps a lot to understand the key concepts of container application development.</p>
</blockquote>
<p>We often find an infinity of tutorials and how-to's that show how to do this work of orchestration, and they do many 
unnecessary things, and aren't automated between independent containers.</p>
<p>This results in unstable development systems, dependent on external scripts that instead of helping, make the task 
difficult. And this is just what <strong>Docker Compose</strong> wants to avoid.</p>
<p>There are several approaches for which Docker Compose can be a good use case. I'm going to focus on two of them; 
<strong>Development environments</strong> and <strong>Single host deployments</strong>.</p>
<p>The goal in this post is to explain how to mount a Node.js environment with Docker Compose and be able to write two 
different Compose files, one that serves us to develop locally and another, with an additional container, that will 
enable us to be able to deploy our application to any server on the internet.</p>
<p>The application <strong>Node.js</strong> that we will dockerize, is one of the example applications that appear in the official page 
of <strong>Socket.IO</strong>, <a href="http://socket.io/get-started/chat/">a chat with websockets</a>.</p>
<p>Our project will have the following structure:</p>
<pre>
⇒  ls 
Dockerfile
README.md
chat_site.conf
docker-compose-prod.yml
docker-compose.yml
index.html
index.js
package.json
</pre>

<p>We'll start with the Node.js part consisting of three files; index.js, index.html and package.json. What the Node files do, 
its explained in <a href="http://socket.io/get-started/chat/">Socket.IO</a> much better than I could do, since I am no expert in Java Script, but it's enough to know that 
they have the logic of the chat. The file that interests us is package.json, since it contains the necessary dependencies 
to be able to execute the application.</p>
<pre>
{
  "name": "socket-chat-example",
  "version": "0.0.1",
  "description": "my first socket.io app",
  "dependencies": {
    "express": "4.10.2",
    "socket.io": "1.2.0"
  }
}
</pre>

<p>In order to be able to dockerize our application, the only thing we have to do is to define a Dockerfile that 'holds' 
all the necessary software to work.</p>
<p>A <strong>Dockerfile</strong>, is a text file that contains a series of commands to execute in the selected image, as it is executed, it 
is composing our container.</p>
<p>Something like this:</p>
<pre>
FROM node:6.9
RUN mkdir /code
WORKDIR /code
ADD . /code/
RUN npm install
</pre>

<p>With '<strong>FROM node:6.9</strong>' we are telling it the image that has to start to create the container, the '<strong>RUN</strong>' command will execute 
in the container any command we tell it, in this case create a directory. '<strong>WORKDIR</strong>' positions the directory indicated, 
'<strong>ADD</strong>' copies the project to the destination directory in the container.</p>
<p>It is important to pay attention to the last line ('<strong>RUN npm install</strong>') since it is the one that installs the package 
needed for the application.</p>
<p>With this we already have a fully functional container with <strong>Node.js</strong> installed and running in it. It's that easy!</p>
<p>The next step is to define a <strong>Docker Compose</strong> file (docker-compose.yml) that looks like this: </p>
<pre>
version: '2'
services:
  node:
    build: .
    volumes:
      - .:/code
      - /code/node_modules
    command: nodejs index.js
    ports:
      - "3000:3000"
</pre>

<p>A Docker Compose file consists of defining your application with services. In this case we only define one service, the 
container Node.js.</p>
<p>We tell it to search the Dockerfile with '<strong>build .</strong>', and map the necessary volumes to the container. We define '<strong>command</strong>' to say to
the container what command to execute when the Dockerfile script finishes. With '<strong>ports</strong>' we open the necessary ports for
Node.js (external port:internal port)</p>
<p>Great. We can now start the dockerize application Node.js with the following command:</p>
<p><code>$ docker-compose up</code></p>
<p>If this is the first time you run this command, <strong>Docker</strong> will download everything you need, in a few seconds you should 
see something similar to this:</p>
<pre>
Building node
Step 1 : FROM node:6.9
6.9: Pulling from library/node
5040bd298390: Pull complete
fce5728aad85: Pull complete
76610ec20bf5: Pull complete
52f3db4b5710: Pull complete
7e5867712a67: Pull complete
563b602246dd: Pull complete
043696f38236: Pull complete
Digest: sha256:40bc08204b9beae97e28c3fc669a3fa1868dea629fd02ec8ec2c1b706cb1f350
Status: Downloaded newer image for node:6.9
 ---> 88717adf5e8a
Step 2 : RUN mkdir /code
 ---> Running in d60a15635dd5
 ---> a3fba1fcea4a
Removing intermediate container d60a15635dd5
Step 3 : WORKDIR /code
 ---> Running in 83d57387b055
 ---> 1dff2466cec9
Removing intermediate container 83d57387b055
Step 4 : ADD . /code/
 ---> 370dbc97eb00
Removing intermediate container 1ab92c89c59c
Step 5 : RUN npm install
 ---> Running in 78cb9ac2f749
...
Output of npm install ...
...
 ---> 703b87fedc3a
Removing intermediate container 78cb9ac2f749
Successfully built 703b87fedc3a
Creating chatnode_node_1
Attaching to chatnode_node_1
node_1   | listening on *:3000
</pre>

<p>Congratulations, you now have your own completely dockerized <strong>Node.js</strong> development environment running! :). I highly recommend 
that you explore the various Docker Compose options for yourself, but for now you just need to know that if you press 
'<strong>Ctrl-C</strong>', the Docker Compose run will stop, although to be sure you can always do: <code>$ docker-compose stop</code>.</p>
<p>To verify that the chat works you can open a browser pointing to <a href="http://localhost:3000">http://localhost:3000</a> and 
send some messages.</p>
<p><img class="img-responsive" src="/static/img/chats.png" alt="Chat working"></p>
<p>Well, now comes the interesting part of <strong>Docker Compose</strong>, we can take as base our file docker-compose.yml and generate a 
similar one, docker-compose-prod.yml in which we will add one more service. This will allow us to mount a web server (<strong>Nginx</strong>), and
be able to distribute our dockerized application Node.js to any internet server.</p>
<pre>
version: '2'
services:

  nginx:
    image: nginx:latest
    volumes:
      - ./chat_site.conf:/etc/nginx/conf.d/site.conf
    ports:
      - "91:80"

    links:
      - node

  node:
    build: .
    volumes:
      - .:/code
      - /code/node_modules
    command: nodejs index.js
    ports:
      - "3000:3000" 
</pre>

<p>As you can see, we've added a new service to the file, the nginx service, this allows us to expose an <strong>HTTP</strong> interface and
be able to do <strong>reverse-proxy</strong> instead of exposing Node.js itself.</p>
<p>The only volume that we need to map in this case is a file with the nginx configuration, let's take a look:</p>
<pre>
server {
    listen 80;

    server_name node.example;

    location / {
        proxy_pass http://node:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
</pre>

<p>It is a classic reverse-proxy file of nginx, the only thing to note is that the variable '<strong>proxy_pass</strong>' points to '<strong>node</strong>' 
which is the name of the service that we have previously defined in the Docker Compose.</p>
<p>We continue with the Docker Compose, exposing the port 80 both internally and externally. Remember that exposing <strong>HTTP</strong>
instead of <strong>HTTPS</strong> is insecure and you should not do so, but this is an example and there is nothing wrong with it.</p>
<p>Last, but not least, we have 'links' which indicates which containers can communicate with each other. As we are doing
reverse-proxy from Nginx to Node.js, we indicate that it has to have a link to it.</p>
<p>And this is it, just deploy it on any server running <code>$ docker-compose -f docker-compose-prod.yml up</code> and Docker will do
the rest :)</p>
<p>It is important to clarify that the use of <strong>Docker Compose</strong> in production environments is quite small and almost always 
goes towards solutions like <a href="https://www.docker.com/products/docker-swarm"><strong>Docker Swarm</strong></a> or more complex like <a href="https://kubernetes.io"><strong>Kubernetes</strong></a>, although personally I consider Docker Compose 
as a very good entry point if what you intended is to practice generating containers, configure them and make a small 
orchestration, so I hope it helps and someone can take advantage of it.</p>
<p>You can take a look at the project on <a href="https://github.com/andonirodriguez/node_chat">GitHub</a> and do your own tests.</p>
<p>Regards.</p>
                    <p class="post-meta">
                        Por <strong><a href="/contact/">Andoni</a></strong> el <strong>6 de Febrero de 2017</strong>
                    </p>
                </div>
            </div>
        </div>
    </article>

    <hr>




    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://twitter.com/AndoniRodriguez">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.linkedin.com/in/andonirodriguez">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/andonirodriguez">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="mailto:andoni.rodriguez@gmail.com">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Copyright &copy; Andoni Rodríguez 2016</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/static/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/static/js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/static/js/clean-blog.min.js"></script>

</body>
</html>
